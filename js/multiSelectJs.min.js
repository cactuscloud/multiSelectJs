function multiSelectJs(t,e){this.initialized=!1,this.initializing=!1,this.updating=!1,this.focusing=!1,this.hasRequest=!1,this.uId=null,this.maxSelections=5,this.maxResults=10,this.template=null,this.form=null,this.main=null,this.selectionArea=null,this.placeholder=null,this.input=null,this.dropdown=null,this.scrollParent=null,this.selectionReferences=[],this.resultReferences=[],this.hoveredReference=null,this.mainHeight=null,this.dataSet=[],this.selections=[],this.results=[],this.selectionString="",this.hoveredData=null,this.duplicateInput=null,this.noResultsMessage="No results found",this.placeholderText="Select an option",this.searchMethod=this.localSearch,this.searchTerms=null,this.lastSearch=null,this.delimiter=";",this.dropdownX=0,this.dropdownY=0,this.dropdownWidth=0,this.dropdownVisible=!1,this.forbiddenCharacters=/[^a-zA-Z0-9 \+\=\-\*\$\%\.\,\!\@\#\&\(\)\;\"\'\?]/,t&&this.init(t,e)}multiSelectJs.Data=function(t,e){this.label=t.trim(),this.value=e.trim().toUpperCase()},Array.isArray||(Array.isArray=function(t){return"[object Array]"===Object.prototype.toString.call(t)}),multiSelectJs.prototype.init=function(t,e){if(this.uId="fs"+("0000"+(Math.random()*Math.pow(36,4)<<0).toString(36)).slice(-4),!this.initialized){if(this.initializing=!0,this.updating=!1,this.focusing=!1,this.parseOptions(e),"string"==typeof t&&(t=document.getElementById(t)),"undefined"==typeof t||!t)throw new TypeError("multiSelectJs requires a valid HTML element to initialize.");if(t.multiSelectJs)throw new Error("A multiSelectJs already exists for this element");this.template=t,this.buildGui(t),this.updateSelectedData(),this.setEventListeners(),t.multiSelectJs=this,this.initialized=!0,this.initializing=!1}},multiSelectJs.prototype.parseOptions=function(t){t||(t={});var e=typeof t.duplicateInput;if("undefined"!==e){var i=t.duplicateInput;if("string"===e&&(i=document.getElementById(i)),!i||!i.hasAttribute)throw new TypeError("An invalid duplicateInput has been supplied to multiSelectJs.");if("INPUT"!==i.tagName||!i.hasAttribute("type"))throw new TypeError("An invalid duplicateInput has been supplied to multiSelectJs.  This be an INPUT with a type of text or hidden.");var e=i.getAttribute("type");if("text"!=e&&"hidden"!=e)throw new TypeError("An invalid duplicateInput has been supplied to multiSelectJs.  This must have a type of text or hidden.");this.duplicateInput=i}if("undefined"!=typeof t.data&&(this.dataSet=multiSelectJs.parseData(data)),e=typeof t.scrollParent,"undefined"!==e){var i=t.scrollParent;"string"===e&&(i=document.getElementById(i)),i&&(this.scrollParent=i)}if(this.scrollParent||(this.scrollParent=document.body),"string"==typeof t.placeholder&&(this.placeholderText=t.placeholder),"string"==typeof t.noResultsMessage&&(this.noResultsMessage=t.noResultsMessage),"number"==typeof t.maxSelections&&(this.maxSelections=t.maxSelections),"number"==typeof t.maxResults&&(this.maxResults=t.maxResults),"string"==typeof t.delimiter&&(this.delimiter=t.delimiter),t.selections&&(this.selections=multiSelectJs.parseData(t.selections)||[]),t.searchMethod){if("function"!=typeof t.searchMethod)throw new TypeError("An invalid searchMethod function has been provided to multiSelectJs");this.searchMethod=t.searchMethod}},multiSelectJs.prototype.buildGui=function(t){var e=document,i=e.createElement("div");i.className="multiSelectJs",i.tabIndex=0,i.innerHTML='<div class="multiSelectJs-loader"></div>';var s=e.createElement("div");s.className="selections",s.innerHTML='<span class="selection-placeholder">&nbsp;</span>',i.appendChild(s);var n=e.createElement("span");n.setAttribute("contenteditable","true"),n.className="multiSelectJs-input",i.appendChild(n);var l=e.createElement("span");l.className="multiSelectJs-placeholderText",l.innerHTML=this.placeholderText,l.setAttribute("spellcheck",!1),i.appendChild(l);var o=e.createElement("div");o.className="multiSelectJs-dropdown",this.main=i,this.selectionArea=s,this.placeholder=l,this.input=n,this.dropdown=o,t.parentElement.insertBefore(i,t),$(t).hide(),this.scrollParent.appendChild(o),this.mainHeight=$(i).height();var h=$(t).closest("form");0!==h.length&&(this.form=h[0])},multiSelectJs.prototype.setEventListeners=function(){null!==this.form&&$(this.form).on("reset."+this.uId,this.reset.bind(this)),$(this.main).on("click."+this.uId,this.mainClick.bind(this)),$(this.main).on("focus."+this.uId,this.focusInput.bind(this)),$(this.main).on("keydown."+this.uId,this.inputKeyDown.bind(this)),$(this.input).on("keyup."+this.uId,this.inputChanged.bind(this)),$(this.input).on("keydown."+this.uId,this.inputKeyDown.bind(this)),$(this.input).on("blur."+this.uId,this.blurInput.bind(this)),$(this.dropdown).on("click."+this.uId,this.dropdownClick.bind(this)),$(window).on("resize."+this.uId+" orientationchange."+this.uId,this.checkDropdownPosition.bind(this)),$(window).on("beforeunload."+this.uId,this.hideDropdown.bind(this)),$(document.body).on("click."+this.uId,this.hideDropdown.bind(this)),$(this.input).on("copy."+this.uId+" cut."+this.uId,this.copy.bind(this))},multiSelectJs.prototype.copy=function(t){t.preventDefault(),window.clipboardData&&window.clipboardData.setData("Text",this.searchTerms)},multiSelectJs.prototype.destroy=function(){this.updating=!0,this.focusing=!0;try{$(document.body).off("."+this.uId),$(window).off("."+this.uId),$(this.input).off("."+this.uId),$(this.main).off("."+this.uId),$(this.dropdown).off("."+this.uId),null!==this.form&&$(this.form).off("."+this.uId)}catch(t){}try{this.dataSet=null,this.selections=null,this.results=null,this.searchMethod=null,this.resultReferences=null}catch(t){}try{this.dropdown.parentNode.removeChild(this.dropdown),this.dropdown=null}catch(t){}try{this.input=null,this.main.parentNode.removeChild(this.main),this.main=null}catch(t){}this.scrollParent=null,this.selectionArea=null,this.hoveredReference=null,this.placeholder=null,this.dropdownVisible=!1,this.uId=null,this.hasRequest=!1,this.initialized=!1,this.initializing=!1;try{$(this.template).show(),this.template.multiSelectJs=null,this.template=null,this.form=null}catch(t){}this.updating=!1,this.focusing=!1},multiSelectJs.prototype.mainClick=function(t){this.focusInput(t,!0)},multiSelectJs.prototype.focusInput=function(t,e){if(this.initialized&&!this.focusing){if(this.focusing=!0,t.stopPropagation(),this.selections.length<this.maxSelections){var i=this.input;i.style.display="inline",$(this.placeholder).addClass("inputVisible");var s=i.firstChild,n=this.isInputEmpty();if(n&&!this.hasRequest)this.showPlaceholder();else{var l=this.searchTerms.length;if(this.showDropdown(),!n&&t.clientX>$(i).offset().left+$(i).width()){var o=window.getSelection();range=document.createRange(),range.setStart(s,l),range.setEnd(s,l),o.removeAllRanges(),o.addRange(range)}}e===!0?$(this.input).focus():window.setTimeout(function(){$(this.input).focus()}.bind(this),0)}this.focusing=!1}},multiSelectJs.prototype.dropdownClick=function(t){t.stopPropagation()},multiSelectJs.prototype.blurInput=function(){if(this.initialized){var t=null===this.input.firstChild,e=""===this.searchTerms;(e||t||this.selections.length>=this.maxSelections)&&(this.input.style.display="none",$(this.placeholder).removeClass("inputVisible"),(e||t)&&(this.placeholder.style.display="inline"))}},multiSelectJs.prototype.showPlaceholder=function(){$(this.input).addClass("placeholderVisible"),this.placeholder.style.display="inline"},multiSelectJs.prototype.hidePlaceholder=function(){$(this.input).removeClass("placeholderVisible"),this.placeholder.style.display="none"},multiSelectJs.prototype.inputChanged=function(t){if(!(!this.initialized||this.updating||this.selections.length>=this.maxSelections)){var e=t.keyCode;if(13!==e&&27!==e&&38!==e&&40!==e){this.updating=!0;var i=this.input,s=$(i).text().trim(),n=s.replace(this.forbiddenCharacters,""),l=s.length-n.length,o=0,h=window.getSelection(),r=null;null!==h.rangeCount&&h.rangeCount>0&&(r=h.getRangeAt(0)),null!==r&&r.commonAncestorContainer.parentNode==i&&(o=r.startOffset-(l>0?l:0)),$(i).text(n);var a=this.isInputEmpty()&&0===n.length;if(a)return this.searchTerms="",this.hideDropdown(),this.showPlaceholder(),void(this.updating=!1);var d=n.length;if(!a){{window.getSelection()}o=Math.min(d,o),r=document.createRange(),r.setStart(i.firstChild,o),r.setEnd(i.firstChild,o),h.removeAllRanges(),h.addRange(r)}if(this.dropdownVisible){var u=$(this.main).height();u!=this.mainHeight&&(this.mainHeight=u,this.prepareToPositionDropdown())}this.searchTerms=n,this.hidePlaceholder(),this.searchTerms!==this.lastSearch||this.hasRequest?this.performSearch():this.showDropdown(),this.updating=!1}}},multiSelectJs.prototype.isInputEmpty=function(){return null===this.input.firstChild||null===this.searchTerms||0===this.searchTerms.length},multiSelectJs.prototype.inputKeyDown=function(t){if(t.stopPropagation(),this.initialized&&!this.updating){var e=t.keyCode;13===e?(t.preventDefault(),this.dropdownVisible?null!==this.hoveredData?this.selectOption(this.hoveredReference):(null===this.results||0===this.results.length)&&this.hideDropdown():null!=this.form&&this.form.submit()):8===e?this.isInputEmpty()&&(t.preventDefault(),this.hideDropdown(),this.lastSearch=null,0!==this.selections.length&&(this.selections.pop(),this.updateSelectedData())):40===e?(t.preventDefault(),this.dropdownVisible?this.incrementHoverIndex(1):null!==this.searchTerms&&this.searchTerms.length>0&&this.selections.length<this.maxSelections&&this.showDropdown()):38===e?(t.preventDefault(),this.dropdownVisible?this.incrementHoverIndex(-1):null!==this.searchTerms&&this.searchTerms.length>0&&this.selections.length<this.maxSelections&&this.showDropdown()):27==e&&this.hideDropdown()}},multiSelectJs.prototype.updateSelectedData=function(){this.updating=!0;for(var t,e,i=this.selectionReferences,s=this.selections,n=s.length,l=0,o=i.length;o>l;l++){for(t=!1,e=0;n>e;e++)if(multiSelectJs.isDataEqual(i[l].value,s[e])){t=!0;break}if(!t){var h=i[l];this.selectionArea.removeChild(h),i.splice(l,1),l--,o--}}o=i.length;var r,a,d=[];for(e=0;n>e;e++){for(d.push(s[e].value),t=!1,l=0;o>l;l++)if(multiSelectJs.isDataEqual(i[l].value,s[e])){t=!0;break}t||(a=document.createElement("span"),a.value=s[e],a.className="selection",a.innerHTML='<span class="selectionText" spellcheck="false">'+s[e].label+"</span>",r=document.createElement("span"),r.className="multiSelectJs-close",r.onclick=this.removeSelection.bind(this),a.appendChild(r),this.selectionReferences.push(a),this.selectionArea.appendChild(a))}if(this.selectionString=d.join(this.delimiter),null!==this.duplicateInput&&(this.duplicateInput.value=this.selectionString),this.dropdownVisible){var u=$(this.main).height();u!=this.mainHeight&&(this.mainHeight=u,this.prepareToPositionDropdown())}this.selections.length<this.maxSelections&&$(this.main).removeClass("full").focus(),this.updating=!1},multiSelectJs.prototype.optionClick=function(t){this.initialized&&this.selectOption(t.target)},multiSelectJs.prototype.selectOption=function(t){if(this.initialized&&this.selections.length<this.maxSelections){var e=t.value;this.selections.push(e),this.updateSelectedData();for(var i=null,s=0,n=this.resultReferences.length;n>s;s++)if(this.resultReferences[s].value===e){i=Math.max(0,s-1);break}if(null===i)throw new Error("Error in multiSelectJs.selectOption(ref).  Supplied reference cannot be found in the dropdown");t.parentElement.removeChild(t);for(var s=0,n=this.results.length;n>s;s++)multiSelectJs.isDataEqual(this.results[s],e)&&(this.results.splice(s,1),this.resultReferences.splice(s,1),s--,n--);null!=this.hoveredData&&(0===this.results.length?(this.hoveredData=null,this.hoveredReference=null):(this.hoveredData=this.results[i],this.hoveredReference=this.resultReferences[i],$(this.hoveredReference).addClass("hovered"))),this.selections.length>=this.maxSelections&&(this.hideDropdown(),$(this.input).text(""),this.searchTerms="",this.lastSearch=null,$(this.main).addClass("full").focus()),0===n&&this.showNoResultsMessage()}},multiSelectJs.prototype.optionEnter=function(t){if(this.initialized){var e=this.hoveredData,i=t.target,s=i.value;if(this.hoveredData=s,!multiSelectJs.isDataEqual(this.hoveredData,e)){$(i).addClass("hovered");for(var n=0,l=this.resultReferences.length;l>n;n++)i=this.resultReferences[n],multiSelectJs.isDataEqual(i.value,s)?this.hoveredReference=i:$(i).removeClass("hovered")}}},multiSelectJs.prototype.incrementHoverIndex=function(t){if(this.initialized){var e,i=this.results,s=this.resultReferences,n=i.length;if(0===n)return this.hoveredData=null,void(this.hoveredReference=null);var l=0;if(null!==this.hoveredData){var o=this.hoveredData;for(e=0;n>e;e++)if(multiSelectJs.isDataEqual(o,i[e])){l=e+t;break}}if(!(0>l||l>=n))for(e=0;n>e;e++)e===l?(this.hoveredReference=s[e],$(this.hoveredReference).addClass("hovered"),this.hoveredData=i[e],this.scrollOptionIntoView(e)):$(s[e]).removeClass("hovered")}},multiSelectJs.prototype.optionExit=function(t){this.initialized&&(this.hoveredData=null,this.hoveredReference=null,$(t.target).removeClass("hovered"))},multiSelectJs.prototype.removeSelection=function(t){if(this.initialized){for(var e=t.target.parentElement.value,i=0,s=this.selections.length;s>i;i++)multiSelectJs.isDataEqual(e,this.selections[i])&&(this.selections.splice(i,1),i--,s--);this.updateSelectedData(),this.hideDropdown(),""!=this.searchTerms&&(this.lastSearch=null,this.performSearch())}},multiSelectJs.prototype.performSearch=function(){if(this.initialized&&!this.hasRequest&&"string"==typeof this.searchTerms&&""!==this.searchTerms.trim()&&this.searchTerms!==this.lastSearch)try{this.hasRequest=!0,this.lastSearch=this.searchTerms,this.searchMethod!==this.localSearch&&($(this.main).addClass("loading"),this.hideDropdown()),this.searchMethod(this.searchTerms,this.selections,this)}catch(t){$(this.main).removeClass("loading"),this.hasRequest=!1}},multiSelectJs.prototype.localSearch=function(t){var e;if(Array.isArray(this.dataSet)){var i=this.dataSet.length;e=0===i?[]:this.findClosestMatches(this.dataSet,t)}else e=null;this.searchCallback(e)},multiSelectJs.prototype.findClosestMatches=function(t,e){function i(t,e){if(0===t.length)return e.length;if(0===e.length)return t.length;var i,s=[];for(i=0;i<=e.length;i++)s[i]=[i];var n;for(n=0;n<=t.length;n++)s[0][n]=n;for(i=1;i<=e.length;i++)for(n=1;n<=t.length;n++)s[i][n]=e.charAt(i-1)==t.charAt(n-1)?s[i-1][n-1]:Math.min(s[i-1][n-1]+1,Math.min(s[i][n-1]+1,s[i-1][n]+1));return s[e.length][t.length]}var s=t.slice(0);e=e.replace(/(&nbsp;)+|\s/gim," ");for(var n=e.split(" "),l=0,o=n.length,h="";o>l;l++){var r=n[l].trim();""===n[l].trim()?(n.splice(l,1),l--,o--):(n[l]=r,h+="(?=.*"+r+")")}var a=new RegExp("^"+h+".*$","igm");h=null,n=null;for(var d=0,u=this.selections.length,o=s.length;u>d;d++)for(l=0;o>l;l++){var c=s[l];multiSelectJs.isDataEqual(c,this.selections[d])&&(s.splice(l,1),l--,o--)}for(l=0;o>l;l++){var c=s[l];c.label.match(a)?s[l].distance=i(s[l].label,e.trim()):(s.splice(l,1),l--,o--)}return s.sort(function(t,e){return t.distance-e.distance}),o>this.maxResults?s.slice(0,this.maxResults):s},multiSelectJs.prototype.searchCallback=function(t){if(this.initialized){if(null===this.searchTerms||""===this.searchTerms.trim())this.lastSearch=this.searchTerms,$(this.main).removeClass("loading");else{if(this.searchTerms!==this.lastSearch)return this.hasRequest=!1,void this.performSearch();this.results=multiSelectJs.parseData(t),this.populateDropdown(),$(this.main).removeClass("loading"),this.showDropdown()}this.hasRequest=!1}},multiSelectJs.prototype.checkDropdownPosition=function(){this.dropdownVisible&&this.prepareToPositionDropdown()},multiSelectJs.prototype.prepareToPositionDropdown=function(){if(this.initialized){var t=this.main;if(null===t.offsetParent)this.hideDropdown();else{var e=this.scrollParent,i=$(t).offset(),s=$(e).offset(),n=this.dropdownTop,l=this.dropdownLeft,o=this.dropdownWidth;e==document.body?(this.dropdownTop=i.top-s.top+$(t).outerHeight(!1)+parseInt($(e).css("marginTop")),this.dropdownLeft=i.left-s.left+parseInt($(e).css("marginLeft"))):(this.dropdownTop=i.top-s.top+$(e).scrollTop()+$(t).outerHeight(),this.dropdownLeft=i.left-s.left+$(e).scrollLeft()),this.dropdownWidth=Math.floor($(t).outerWidth(!1)),(n!=this.dropdownTop||l!=this.dropdownLeft||o!=this.dropdownWidth)&&(window.requestAnimationFrame?this.frameRequested||(window.requestAnimationFrame(this.positionDropdown.bind(this)),this.frameRequested=!0):this.positionDropdown())}}},multiSelectJs.prototype.positionDropdown=function(){this.initialized&&($(this.dropdown).css({top:this.dropdownTop,left:this.dropdownLeft,minWidth:this.dropdownWidth}),$(this.dropdown).outerWidth(this.dropdownWidth),this.frameRequested=!1)},multiSelectJs.prototype.scrollOptionIntoView=function(t){if(this.initialized&&this.dropdownVisible&&0!==this.results.length){var e=this.dropdown,i=this.resultReferences[t],s=$(i).position().top,n=$(i).innerHeight(),l=($(e).offset().top,$(e).innerHeight());0>s?e.scrollTop+=s:s+n>l&&(e.scrollTop+=s+n-l),$(i).offset().top<$(window).scrollTop()?i.scrollIntoView(!0):$(i).offset().top+$(i).innerHeight()>$(window).scrollTop()+window.innerHeight&&i.scrollIntoView(!1)}},multiSelectJs.prototype.hideDropdown=function(t){this.dropdownVisible&&this.initialized&&(t===!0?$(this.dropdown).hide():$(this.dropdown).stop().fadeOut(),this.hoveredData=null,this.hoveredReference=null,$(this.resultReferences).removeClass("hovered"),this.dropdownVisible=!1)},multiSelectJs.prototype.showDropdown=function(){this.dropdownVisible!==!0&&this.initialized&&(this.prepareToPositionDropdown(),this.hoveredData=null,this.hoveredReference=null,this.dropdownVisible=!0,$(this.dropdown).stop().fadeIn())},multiSelectJs.prototype.populateDropdown=function(){if(this.initialized){var t,e=this.dropdown,i=this.results,s=document,n=i.length;if(e.innerHTML="",this.resultReferences=[],0===n)this.showNoResultsMessage();else for(var l=0;n>l;l++)t=s.createElement("div"),t.className="multiSelectJs-option",$(t).text(i[l].label),t.value=i[l],t.onmouseover=this.optionEnter.bind(this),t.onmouseout=this.optionExit.bind(this),t.onclick=this.optionClick.bind(this),this.resultReferences.push(t),e.appendChild(t)}},multiSelectJs.prototype.showNoResultsMessage=function(){if(this.initialized){this.dropdown.innerHTML="";var t=document.createElement("div");t.className="multiSelectJs-noResults",$(t).text(this.noResultsMessage),t.onclick=this.hideDropdown.bind(this),this.dropdown.appendChild(t)}},multiSelectJs.prototype.setSelections=function(t){this.initialized&&(this.selections=multiSelectJs.parseData(t),this.updateSelectedData())},multiSelectJs.prototype.getSelections=function(){return this.initialized?this.selections:null},multiSelectJs.prototype.getValue=function(){return this.initialized?this.selectionString:null},multiSelectJs.prototype.addSelections=function(t){if(this.initialized){var e=multiSelectJs.parseData(t);if(0===e.length)return;this.selections.concat(e),this.updateSelectedData()}},multiSelectJs.prototype.removeSelections=function(t){if(this.initialized){var e,i=multiSelectJs.parseData(t),s=0,n=this.selections.length,l=i.length;if(0===l||0===n)return;for(;n>s;s++)for(e=0;l>e;e++)if(multiSelectJs.isDataEqual(this.selections[s],i[e])){t.splice(e,1),this.selections.splice(s,1),s--,n--,e--,l--;break}this.updateSelectedData()}},multiSelectJs.prototype.reset=function(){this.initialized&&(this.selections=[],this.updateSelectedData())},multiSelectJs.isVisible=function(t){var e=$(t).outerWidth(),i=$(t).outerHeight();return 0!==e&&0!==i&&0!==t.style.opacity&&"hidden"!==t.style.visibility},multiSelectJs.isDataEqual=function(t,e){return null===t||null===e||"string"!=typeof t.value||"string"!=typeof e.value?!1:t.value===e.value},multiSelectJs.parseData=function(t){if(null===t)return[];var e=[],i=typeof t;if("string"===i)try{t=JSON.parse(t)}catch(s){throw new TypeError("Invalid "+i+" entered into multiSelectJs.parseData().  If using a string, it must represent a JSON encoded array of objects with 'value' and 'label' parameters as strings.")}if(t===[])return[];if(!Array.isArray(t))throw new TypeError("Invalid "+i+" entered into multiSelectJs.parseData().  If using a string, it must represent a JSON encoded array of objects with 'value' and 'label' parameters as strings.");for(var n=0,l=t.length;l>n;n++){var o=t[n];"string"==typeof o.label&&"string"==typeof o.value&&e.push(o)}return e};